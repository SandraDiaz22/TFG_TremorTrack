{% extends "layout.html" %} <!--Herencia de layout-->

{% block head %}

    <title>{% trans %}Listado pacientes{% endtrans %}</title>

{% endblock %}



{% block body %}

    <!--Contenido de la página-->
    <div class="container mt-4 mb-4">

        <!--Migas de pan-->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/BienvenidaMedico">{% trans %}Bienvenido{% endtrans %}</a></li>
                <li aria-current="page" class="breadcrumb-item active">{% trans %}Listado de Pacientes{% endtrans %}</li>
            </ol>
        </nav>

        <h1>{% trans %}Listado pacientes{% endtrans %}</h1>
        <table class="table">
            <thead>
                <tr> <!--Títulos tabla-->
                    <th>{% trans %}ID{% endtrans %}</th>
                    <th>{% trans %}Nombre{% endtrans %}</th>
                    <th>{% trans %}Foto{% endtrans %}</th>
                    <th>{% trans %}Acciones{% endtrans %}</th>
                </tr>
            </thead>
            <tbody>
                {% for paciente in pacientes %} <!--Por cada paciente del médico-->
                <tr>
                    <td>{{ paciente.id_paciente }}</td>
                    <td>{{ paciente.nombre }}</td>
                    <td><img src="{{ paciente.foto }}" alt="Foto del paciente" style="max-width: 100px;"></td>
                    <td>
                        <button class="btn btn-info mostrar-info" data-id="{{ paciente.id_paciente }}">{% trans %}Información personal{% endtrans %}</button>
                        <div class="datos-personales" style="display: none;"> <!--Datos invisibles-->
                            <form class="formulario-edicion" id="formulario-datos-personales-{{ paciente.id_paciente }}"><!--Muestra los datos y permite cambiarlos-->
                                <input type="hidden" name="id_paciente" value="{{ paciente.id_paciente }}"><!--Para identificar qué paciente es en la funcion-->
                                
                                <div class="form-group flex-container"> <!--Lateralidad y sensor-->
                                    <div class="flex-item">
                                        <label for="lateralidad">{% trans %}Lateralidad:{% endtrans %}</label>
                                        <br>
                                        <select id="lateralidad" name="lateralidad">
                                            <option value="diestro" {% if paciente.lateralidad == 'diestro' %} selected {% endif %}>{% trans %}Diestro{% endtrans %}</option>
                                            <option value="zurdo" {% if paciente.lateralidad == 'zurdo' %} selected {% endif %}>{% trans %}Zurdo{% endtrans %}</option>
                                        </select>                                        
                                    </div>
                                    <div class="flex-item">
                                        <label for="sensor">{% trans %}Sensor:{% endtrans %}</label>
                                        <br>
                                        <select id="sensor" name="sensor">
                                            <option value="si" {% if paciente.sensor == 'SI' %} selected {% endif %}>{% trans %}Sí{% endtrans %}</option>
                                            <option value="no" {% if paciente.sensor == 'NO' %} selected {% endif %}>{% trans %}No{% endtrans %}</option>
                                        </select>
                                    </div>
                                </div>
                                <!--Fecha de nacimiento, dirección, teléfono-->
                                <label for="fecha_de_nacimientoP">{% trans %}Fecha de Nacimiento:{% endtrans %}</label>
                                <input type="date" id="fecha_de_nacimientoP" name="fecha_de_nacimientoP" value="{{ paciente.fecha_de_nacimiento }}"><br>
                            
                                <label for="direccionP">{% trans %}Dirección:{% endtrans %}</label>
                                <input type="text" id="direccionP" name="direccionP" value="{{ paciente.direccion }}"><br>
                            
                                <label for="telefonoP">{% trans %}Teléfono:{% endtrans %}</label>
                                <input type="text" id="telefonoP" name="telefonoP" value="{{ paciente.telefono }}"><br>
                                
                                <button type="submit" class="boton-guardar" data-id-paciente="{{ paciente.id_paciente }}" style="padding: 10px 20px; background-color: #2fa94c;">{% trans %}Guardar cambios{% endtrans %}</button>
                                <button type="button" class="btn-cancelar boton-cancelarCambios">{% trans %}Cancelar{% endtrans %}</button>
                            </form>
                        </div>
                        <br>

                        <button class="btn btn-primary subir-videos">{% trans %}Subir vídeo{% endtrans %}</button>
                        <div class="formulario-videos" style="display: none;"> <!--Formulario subir vídeo-->
                            <form action="/subirVideo/{{ paciente.id_paciente }}" method="post" enctype="multipart/form-data" id="formularioSubirVideo">
                                <div class="form-group">
                                    <label for="archivo_video">{% trans %}Archivo de vídeo:{% endtrans %}</label> <!--Vídeo-->
                                    <input type="file" name="archivo_video" accept="video/*" required>
                                </div>
                                <div class="form-group">
                                    <label for="fecha_video">{% trans %}Fecha del vídeo:{% endtrans %}</label> <!--Fecha del vídeo-->
                                    <input type="date" id="fecha_video" name="fecha_video" required>
                                </div>
                                <div class="form-group flex-container">
                                    <div class="flex-item">
                                        <label for="mano">{% trans %}Mano del vídeo:{% endtrans %}</label> <!--Mano del vídeo-->
                                        <select id="mano" name="mano" required>
                                            <option value="">{% trans %}Seleccionar{% endtrans %}</option>
                                            <option value="derecha">{% trans %}Derecha{% endtrans %}</option>
                                            <option value="izquierda">{% trans %}Izquierda{% endtrans %}</option>
                                        </select>
                                    </div>
                                    <div class="flex-item">
                                        <label for="lentitud">{% trans %}Lentitud:{% endtrans %}</label> <!--Lentitud del vídeo-->
                                        <select id="lentitud" name="lentitud" required>
                                            <option value="">{% trans %}Seleccionar{% endtrans %}</option>
                                            <option value="0">{% trans %}0{% endtrans %}</option>
                                            <option value="1">{% trans %}1{% endtrans %}</option>
                                            <option value="2">{% trans %}2{% endtrans %}</option>
                                            <option value="3">{% trans %}3{% endtrans %}</option>
                                            <option value="4">{% trans %}4{% endtrans %}</option>
                                        </select>
                                    </div>
                                    <div class="flex-item">
                                        <label for="amplitud">{% trans %}Amplitud:{% endtrans %}</label> <!--Amplitud del vídeo-->
                                        <select id="amplitud" name="amplitud" required>
                                            <option value="">{% trans %}Seleccionar{% endtrans %}</option>
                                            <option value="0">{% trans %}0{% endtrans %}</option>
                                            <option value="1">{% trans %}1{% endtrans %}</option>
                                            <option value="2">{% trans %}2{% endtrans %}</option>
                                            <option value="3">{% trans %}3{% endtrans %}</option>
                                            <option value="4">{% trans %}4{% endtrans %}</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-2 subirFormVideo">{% trans %}Subir vídeo{% endtrans %}</button>
                                <div class="subiendo" style="display: none;">
                                    <p>{% trans %}Subiendo...(esto podría tardar unos minutos){% endtrans %}</p><!--Mensaje mientras se sube el vídeo-->
                                </div>
                            </form>
                        </div>
                        
                        
                        
                        <a href="/mostrarVideos/{{ paciente.id_paciente }}" class="btn btn-secondary">{% trans %}Mostrar vídeos{% endtrans %}</a>


                        <button class="btn btn-success subir-datos">{% trans %}Subir datos sensor{% endtrans %}</button> <!--Subir datos sensor-->
                        <div class="formulario-datos" style="display: none;"><!--Formulario invisible-->
                            <form action="/subirDatosSensor/{{ paciente.id_paciente }}" method="post" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label for="archivo_sensor">{% trans %}Archivo CSV:{% endtrans %}</label>
                                    <input type="file" name="archivo_sensor" accept=".csv" required> <!--Primer filtrado para el cliente-->
                                </div>

                                <button type="submit" class="btn btn-primary mt-2">{% trans %}Subir archivo CSV{% endtrans %}</button>
                            </form>
                        </div>

                        <!--Mostrar datos sensor-->
                        <a href="/mostrarDatosSensor/{{ paciente.id_paciente }}" class="btn btn-secondary">{% trans %}Mostrar datos sensor{% endtrans %}</a>

                    </td>

                {% endfor %}
            </tbody>
        </table>     
   
    </div>

    <!-- Bootstrap-table filter -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-table/dist/bootstrap-table.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <!-- AJAX-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <script>
        $(document).ready(function(){
            $(".mostrar-info").click(function(){
                var pacienteId = $(this).data("id");
                $(this).next(".datos-personales").toggle();//Muestra más datos
            });

            $(".subir-videos").click(function(){
                $(this).next(".formulario-videos").toggle(); //Muestra el formulario para subir videos
            });

            $(".subir-datos").click(function(){
                $(this).next(".formulario-datos").toggle(); //Muestra el formulario para subir csv
            });
        });

        //----------------------------------------------------------------
        //Lógica para mostrar mensajes al usuario mientras se analiza el 
        //vídeo que se sube en el formulario
        $(document).ready(function() {
            $('.subirFormVideo').on('click', function(e) {
                e.preventDefault(); //Evitar que se envie el formulario todavia
                let form = $(this).closest('form');
                //Validación de campos
                let fileInput = form.find('input[type="file"]');
                let dateInput = form.find('#fecha_video');
                let manoSelect = form.find('#mano');
                let lentitudSelect = form.find('#lentitud');
                let amplitudSelect = form.find('#amplitud');

                if (!fileInput.val() || !dateInput.val() || !manoSelect.val() || !lentitudSelect.val() || !amplitudSelect.val()) {
                    alert('{% trans %}Por favor, complete todos los campos.{% endtrans %}');
                    return;
                }
                
                //Mostrar mensaje subiendo...
                var subiendo = form.find('.subiendo');
                subiendo.show();

                //URL donde subir los datos
                var URLformulario = form.attr('action');
                //Datos del formulario
                var formData = new FormData(form[0]);

                //Enviar formulario mediante AJAX
                $.ajax({
                    url: URLformulario,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,

                    //Si sale todo bien
                    success: function(response) {
                        subiendo.hide(); //Ocultamos botón
                        alert(response.message); //Mensaje de éxito

                        //Redireccionar al usuario a la página anterior
                        window.location.href = '/listadoPacientes';
                    },

                    //Si hay algún error
                    error: function(xhr, status, error) {
                        console.error(xhr.responseText);
                        subiendo.hide(); //Ocultamos botón
                        alert('{% trans %}Error al subir el archivo de vídeo.{% endtrans %}');
                    }
                });
            });
        });
        //----------------------------------------------------------------

        
        //----------------------------------------------------------------
        //Cuando se pulsa el botón de guardar cambios al editar los datos de los pacientes se llama a la 
        //función que actualiza esos datos en la bbdd y dependiendo del resultado se alerta al usuario
        document.addEventListener('DOMContentLoaded', function() {
            let valoresIniciales = {};// Capturar valores iniciales para cada formulario de pacientes
            document.querySelectorAll('.formulario-edicion').forEach(formulario => {
                let idPaciente = formulario.querySelector('input[name="id_paciente"]').value;
                valoresIniciales[idPaciente] = {};
                formulario.querySelectorAll('select').forEach(select => {
                    valoresIniciales[idPaciente][select.name] = select.value;
                });
            });
            document.querySelectorAll('.boton-guardar').forEach(function(boton) { //Cuando le den a guardar
                boton.addEventListener('click', function(event) {
                    event.preventDefault();
                    const formulario = boton.closest('form'); //formulario asociado a este botón
                    const formData = new FormData(formulario);
                    
                    //Validar si hay cambios en el formulario para cambios input(contraseña vacía)
                    let cambios = false;
                    formulario.querySelectorAll('input').forEach(input => {
                        if (input.value !== input.defaultValue) {
                            cambios = true; } });

                    //Validar si hay cambios en campos select
                    let idPaciente = this.getAttribute('data-id-paciente'); //Obtener el id del paciente
                    formulario.querySelectorAll('select').forEach(select => {
                        if (select.value !== valoresIniciales[idPaciente][select.name]) {
                                cambios = true; } });
                    
                    if (!cambios) { //Si no han realizado cambios
                        alert('{% trans %}No hay cambios para guardar.{% endtrans %}');
                        return;
                    }

                    //Validar los datos
                    if (!validarDatos(formData)) {
                        return; //Detener el envío del formulario
                    }

                    fetch('/actualizar_datos_personales', {
                        method: 'POST',
                        body: formData //Lo mandamos por aqui
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('{% trans %}Paciente editado correctamente{% endtrans %}'); //Bien
                            location.reload(); //Recargar la página
                        } else {
                            alert('{% trans %}Error al editar el paciente{% endtrans %}');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('{% trans %}Error al editar el paciente{% endtrans %}');
                    });
                });
            });
            //Si decide cancelar los cambios, limpia el form
            document.querySelectorAll('.boton-cancelarCambios').forEach(function(botonCancelar) {
                botonCancelar.addEventListener('click', function(event) {
                    const formulario = event.target.closest('form');
                    formulario.reset(); //Restaurar valores originales
                });
            });
        });
        //----------------------------------------------------------------

        //Función para validar los datos del formulario (número de 9 cifras, fecha de nacimiento razonable, dirección normal)
        function validarDatos(formData) {
            //Validar teléfono
            var telefono = formData.get("telefonoP");
            var telefonoRegex = /^[0-9]{9}$/; //RE para 9 números
            if (!telefonoRegex.test(telefono)) { //Si no tiene 9 números mostramos error y cancelamos form
                alert("{% trans %}El teléfono debe contener exactamente 9 números.{% endtrans %}");
                return false;
            }


            //Validar fecha de nacimiento
            var fechaNacimiento = formData.get("fecha_de_nacimientoP");
            //Convertir a Date
            var fechaNacimientoDate = new Date(fechaNacimiento);

            //Como mínimo debe tener 18 años y como máximo 100
            var fechaActual = new Date();
            var fechaMinima = new Date(fechaActual);
            fechaMinima.setFullYear(fechaMinima.getFullYear() - 100); //100 años
            var fechaMaxima = new Date(fechaActual);
            fechaMaxima.setFullYear(fechaMaxima.getFullYear() - 18); //18 años

            //Si la fecha no está en el rango permitido, error y cancelamos form
            if (fechaNacimientoDate < fechaMinima || fechaNacimientoDate > fechaMaxima) {
                alert("{% trans %}La fecha de nacimiento debe estar entre{% endtrans %}" + fechaMaxima.getFullYear() + "{% trans %} y {% endtrans %}" + fechaMinima.getFullYear() + ".");
                return false;
            }


            //Validar direccion
            var direccion = formData.get("direccionP");
            if (direccion.length > 100) {
                alert("{% trans %}La dirección es demasiado larga.{% endtrans %}");
                return false; //Demasiado larga
            }
            //Si tiene caracteres que no son propios de una direccion, error y cancelamos form
            var direccionRegex = /^[A-Za-z0-9áéíóúÁÉÍÓÚ.,ºª\-# ]+$/;
            if (!direccionRegex.test(direccion)) {
                alert("{% trans %}La dirección tiene caracteres no permitidos.{% endtrans %}");
                return false;
            }


            
            //Si todo está bien
            return true;
        }
    </script>


{% endblock %}