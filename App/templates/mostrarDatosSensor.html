{% extends "layout.html" %} <!--Herencia de layout-->

{% block head %}

    <title>{% trans %} Datos sensor {% endtrans %}</title>

    <!--Biblioteca para los gráficos-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--Biblioteca para los calendarios-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">

    
{% endblock %}



{% block body %}
    
    <!--Paciente-->
    <h1> <img src="{{bbddpaciente.foto}}" alt="Imagen del paciente" class="logo">{% trans %} Paciente: {% endtrans %} {{bbddpaciente.nombre}} {{bbddpaciente.apellido}} </h1>
    

    <!--Formulario para saber qué gráfica mostrar-->
    <form id="formulario" action="" method="post">
        <label for="seleccionGrafico">{% trans %} Selecciona la gráfica a mostrar: {% endtrans %}</label>
        
        <select id="seleccionGrafico" name="seleccionGrafico" required>
            <option value="">{% trans %} Seleccionar {% endtrans %}</option>
            <option value="1">{% trans %} Parámetros de Bradicinesia {% endtrans %}</option>
            <option value="2">{% trans %} Parámetros de FoG y Discinesia {% endtrans %}</option>
            <option value="3">{% trans %} Información de los pasos {% endtrans %}</option>
            <option value="4">{% trans %} Parámetros de Estado Motor, Discinesia y Bradicinesia a 10 min {% endtrans %}</option>
        </select>

        <div class="flatpickr">
            <label for="calendario">Selecciona las fechas a mostrar:</label>
            <input type="text" placeholder="Seleciona fechas..." id="calendario" name="calendario" required>
            <p id="mensaje-fechas-disponibles">Fechas disponibles: cargando...</p>
        </div>

        <input type="hidden" name="id_paciente" value="{{ bbddpaciente.id_paciente }}"> <!--Para saber qué paciente es-->

        <button type="submit" class="btn btn-primary mt-2">{% trans %} Mostrar datos {% endtrans %}</button>
    </form>

    <!--Gráfica usando chart-->
    <div id="graficoDefinitivo"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        let fechaInicio;
        let fechaFin;
        var datos_grafico;

        document.addEventListener('DOMContentLoaded', function () {
            let fechasDisponibles = JSON.parse('{{ fechas | safe }}'); //Convertir la cadena JSON a un array de JavaScript
            actualizarMensajeFechasDisponibles(fechasDisponibles);

            //Si hay fechas disponibles se muestra en el calendario la primera fecha disponible, sino la fecha actual.
            let fechaPredeterminada;
            if (fechasDisponibles.length > 0) {
                fechaPredeterminada = fechasDisponibles[0]; //La primera fecha con registros
            } else {
                fechaPredeterminada = new Date(); //Fecha actual
            }

            flatpickr('#calendario', {
                dateFormat: 'Y-m-d', //Formato de las fechas
                mode: 'range', //Permite seleccionar un rango de fechas
                enable: fechasDisponibles, //Permitir solo el rango de fechas en el que hay registros
                locale:'es', //Español
                defaultDate: fechaPredeterminada, //Fecha mostrada inicialmente

                onChange: function (selectedDates, dateStr) {//Guardar fechas
                    //Si solo elige una, es tanto fecha inicio como fin
                    if (selectedDates.length === 1) {
                        fechaInicio = selectedDates[0];
                        fechaFin = selectedDates[0];
                    
                    //Si elige un rango
                    } else if (selectedDates.length === 2) {
                        fechaInicio = selectedDates[0];
                        fechaFin = selectedDates[1];
                    }
                },
                onReady: function (selectedDates, dateStr, instance) {
                    //Limpia la selección automática al principio
                    instance.clear();
                }
            });
        });

        //Divide las fechas disponibles en rangos y muestra dichos rangos al usuario
        //para facilitar la seleccion de las fechas
        function actualizarMensajeFechasDisponibles(fechasDisponibles) {
            let mensaje = 'Fechas disponibles: <br>';
            let rangos = [];
            let inicioRango = fechasDisponibles[0];
            let finRango = fechasDisponibles[0];
            
            for (let i = 1; i < fechasDisponibles.length; i++) {
                let fechaActual = fechasDisponibles[i];
                let fechaAnterior = fechasDisponibles[i - 1];
                
                //Si la fecha actual es consecutiva a la fecha anterior
                if (new Date(fechaActual) - new Date(fechaAnterior) === 86400000) {
                    finRango = fechaActual; //Actualizar el final del rango
                } else {
                    //Sino, finalizar el rango actual y comenzar uno nuevo
                    rangos.push(inicioRango === finRango ? inicioRango : inicioRango + ' a ' + finRango);
                    inicioRango = fechaActual;
                    finRango = fechaActual;
                }
            }
            
            //Agregar el último rango
            rangos.push(inicioRango === finRango ? inicioRango : inicioRango + ' a ' + finRango);
            
            mensaje += rangos.join('<br>'); //Salto de linea después de cada rango
            
            document.getElementById('mensaje-fechas-disponibles').innerHTML = mensaje; //Mostrar mensaje
        }


        //Listener que muestra el gráfico cuando se da a "Mostrar datos"
        document.getElementById('formulario').addEventListener('submit', function(event) { 
            event.preventDefault();

            //Datos del formulario (seleccion + fechas)
            const formData = new FormData(document.getElementById('formulario'));

            //Ajustar las fechas globales a la zona horaria (+1 día)
            const fechaInicioAjustada = new Date(fechaInicio.getTime() - (fechaInicio.getTimezoneOffset() * 60000));
            const fechaFinAjustada = new Date(fechaFin.getTime() - (fechaFin.getTimezoneOffset() * 60000));
            //Las añadimos como strings
            formData.append('fechaInicio', fechaInicioAjustada.toISOString().split('T')[0]);
            formData.append('fechaFin', fechaFinAjustada.toISOString().split('T')[0]);


            //Solicitud AJAX al servidor Flask
            fetch('/crearGrafico', {
                method: 'POST',
                body: formData //Le pasamos los datos del formulario
            })
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos:', data);

                if (data && data.datos_grafico) {
                    try {
                        //Cadena JSON con los datos
                        const chartData = JSON.parse(data.datos_grafico);
                        
                        const generalTitle = chartData[0].GeneralTitle;
                        chartData.shift(); //Elimina el titulo

                        //Si chartData es un array y no está vacío
                        if (Array.isArray(chartData) && chartData.length > 0) {

                            const contenedorGraficoDefinitivo = document.getElementById('graficoDefinitivo');
                            contenedorGraficoDefinitivo.innerHTML = ''; //Limpiar contenedor

                            //Crear h2 para el título general
                            const tituloGeneral = document.createElement('h2');
                            tituloGeneral.textContent = generalTitle;

                            //Título general antes de los gráficos
                            contenedorGraficoDefinitivo.appendChild(tituloGeneral);

                            //Crear un nuevo gráfico para cada conjunto de datos
                            chartData.forEach(chart => {
                                const ctx = document.createElement('canvas');
                                contenedorGraficoDefinitivo.appendChild(ctx);

                                // Agregar título del eje Y
                                //chart.datasets.forEach(dataset => {
                                //    dataset.yAxisID = dataset.yAxisID || 'defaultYAxis';
                                //});

                                const myChart = new Chart(ctx.getContext('2d'), {
                                    type: 'line', //scatter no funciona
                                    data: chart,
                                    options: {
                                        plugins: {
                                            title: {
                                                display: true,
                                                text: chart.datasets[0].yAxisID,
                                                position: 'left'
                                            }
                                        },
                                        elements: {
                                            point: {
                                                backgroundColor: 'rgba(0, 0, 0, 0)', //Líneas transparentes
                                                borderColor: 'rgba(72, 158, 238, 1)' //Puntos en azul
                                            }
                                        }
                                    }
                                });
                            });

                        } else {
                            console.error('La clave datos_grafico no contiene un array válido.');
                        }
                    } catch (error) {
                        console.error('Error al analizar los datos_grafico:', error);
                    }
                } else {
                    console.error('No se encontró la clave datos_grafico o está vacía en los datos recibidos.');
                }
            })
            .catch(error => {
                console.error('Error al procesar la respuesta:', error);
            });
        });
    </script>

{% endblock %}