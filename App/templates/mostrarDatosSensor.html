{% extends "layout.html" %} <!--Herencia de layout-->

{% block head %}

    <title>{% trans %} Datos sensor {% endtrans %}</title>

    <!--Biblioteca para los gráficos-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--Biblioteca para los calendarios-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{% endblock %}



{% block body %}
    
    <!--Paciente-->
    <h1> <img src="{{bbddpaciente.foto}}" alt="Imagen del paciente" class="logo">  Paciente: {{bbddpaciente.nombre}} {{bbddpaciente.apellido}} (id: {{bbddpaciente.id_paciente}})</h1>
    

    <!--Formulario para saber qué gráfica mostrar-->
    <form id="formulario" action="" method="post">
        <label for="seleccionGrafico">{% trans %} Selecciona la gráfica a mostrar: {% endtrans %}</label>
        <select id="seleccionGrafico" name="seleccionGrafico" required>
            <option value="">{% trans %} Seleccionar {% endtrans %}</option>
            <option value="1">{% trans %} Parámetros de Bradicinesia {% endtrans %}</option>
            <option value="2">{% trans %} Parámetros de FoG y Discinesia {% endtrans %}</option>
            <option value="3">{% trans %} Información de los pasos {% endtrans %}</option>
            <option value="4">{% trans %} Parámetros de Estado Motor, Discinesia y Bradicinesia a 10 min {% endtrans %}</option>
        </select>


        <label for="calendario">Selecciona las fechas a mostrar(7):</label>
        <input type="text" id="calendario" name="calendario" required>


        <button type="submit" class="btn btn-primary mt-2">{% trans %} Mostrar datos {% endtrans %}</button>
    </form>

    <!--Gráfica usando chart-->
    <div id="graficoDefinitivo"></div>


    <!--Gráfica usando plot3Axis-->
    <div id="imagenGrafo" style="width: 800px; height: 1200px; margin: 0 auto; margin-bottom: 20px; display: none;">
    <h2 class="mb-4">{% trans %}Gráfico de plot3Axis{% endtrans %}</h2>
        <img id="imagenGrafico" src="" style="max-width: 100%; height: auto;">
    </div>

    <!--Gráfica usando chart con datos locos-->
    <div id="contenedorGrafico" style="width: 800px; height: 400px; margin: 0 auto; display: none;">
        <h2 class="mb-4">{% trans %}Gráfico con datos locos{% endtrans %}</h2>
        <canvas id="grafico"></canvas>
    </div>


    <script>
        let fechaInicio;
        let fechaFin;
        var datos_grafico;

        document.addEventListener('DOMContentLoaded', function () {
            flatpickr('#calendario', {
                dateFormat: 'Y-m-d',
                mode: 'range', //Permite seleccionar un rango de fechas
                inline: true,
                onChange: function (selectedDates, dateStr) {
                if (selectedDates.length === 2) {
                    fechaInicio = selectedDates[0];
                    fechaFin = selectedDates[1];

                    const añoInicio = fechaInicio.getFullYear();
                    const mesInicio = fechaInicio.getMonth() + 1;
                    const añoFin = fechaFin.getFullYear();
                    const mesFin = fechaFin.getMonth() + 1;
                }
            }
            });
        });

        //Listener que muestra el gráfico cuando se da a "Mostrar datos"
        document.getElementById('formulario').addEventListener('submit', function(event) { 
            //mostrarGrafico(fechaInicio, fechaFin);
            event.preventDefault();

            //Datos del formulario
            const formData = new FormData(document.getElementById('formulario'));
            const fechaInicio = formData.get('calendario').split(' to ')[0];
            const fechaFin = formData.get('calendario').split(' to ')[1];
            formData.append('fechaInicio', fechaInicio);
            formData.append('fechaFin', fechaFin);

            //Solicitud AJAX al servidor Flask
            fetch('/crearGrafico', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Datos recibidos:', data);

                // // Muestra el gráfico utilizando los datos recibidos del servidor
                // if (data.datos_grafico !== "") {
                //     // Hacer visible el div de la imagen y actualizar la imagen
                //     document.getElementById('imagenGrafo').style.display = 'block';
                //     document.getElementById('imagenGrafico').src = "data:image/png;base64," + data.datos_grafico;
                //     // Obtener la referencia de la imagen
                //     const imagenGrafico = document.getElementById('imagenGrafico');
                // } else {
                //     // Si los datos del gráfico no están disponibles, ocultar el div de la imagen
                //     document.getElementById('imagenGrafo').style.display = 'none';
                // }
                    // Verificar si la clave datos_grafico existe y no está vacía



                    //Esta es la parte que funciona para 3 graficos en a y d pero no en b y c
                if (data && data.datos_grafico) {
                    try {
                        //Cadena JSON con los datos
                        const chartData = JSON.parse(data.datos_grafico);

                        //Si chartData es un array y no está vacío
                        if (Array.isArray(chartData) && chartData.length > 0) {

                            const contenedorGraficoDefinitivo = document.getElementById('graficoDefinitivo');
                            contenedorGraficoDefinitivo.innerHTML = ''; // Limpiar contenedor de gráficos

                            // Crear un nuevo gráfico para cada conjunto de datos recibido
                            chartData.forEach(chart => {
                                const ctx = document.createElement('canvas');
                                contenedorGraficoDefinitivo.appendChild(ctx);
                                const myChart = new Chart(ctx.getContext('2d'), {
                                    type: 'line',
                                    data: chart,
                                    options: {
                                        scales: { y: { beginAtZero: true } }
                                    }
                                });
                            });

                            //Llamar a la función mostrarGrafico que es la de prueba anterior
                            mostrarGrafico(fechaInicio, fechaFin);
                        } else {
                            console.error('La clave datos_grafico no contiene un array válido.');
                        }
                    } catch (error) {
                        console.error('Error al analizar los datos_grafico:', error);
                    }
                } else {
                    console.error('No se encontró la clave datos_grafico o está vacía en los datos recibidos.');
                }
            })
            .catch(error => {
                console.error('Error al procesar la respuesta:', error);
            });
        });
            



        //Funcion que genera un gráfico
        function mostrarGrafico(fechaInicio, fechaFin) {
            //Título del gráfico dependiendo de la opcion seleccionada
            var titulo = ''; 
            var seleccion = document.getElementById('seleccionGrafico').value;
            switch (seleccion) {
                case '1':
                    titulo = 'Parámetros de Bradicinesia'; break;
                case '2':
                    titulo = 'Parámetros de FoG y Discinesia'; break;
                case '3':
                    titulo = 'Información de los pasos'; break;
                case '4':
                    titulo = 'Parámetros de Estado Motor, Discinesia y Bradicinesia a 10 min'; break;
                default:
                    titulo = '';
            }

            //Rango de fechas entre fecha inicio y fecha fin
            const labels = [];
            const fechaActual = new Date(fechaInicio);
            while (fechaActual <= fechaFin) {
                //Meter la fecha actual en la matriz
                labels.push(fechaActual.toISOString().split('T')[0]);
                //Incrementar un día la fecha actual
                fechaActual.setDate(fechaActual.getDate() + 1);
            }


            var ctx = document.getElementById('grafico').getContext('2d');
            var grafico = new Chart(ctx, {
                type: 'line',
                
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'], //labels,
                    datasets: [{
                        label: titulo,
                        data: [65, 59, 80, 81, 56, 55, 40], //data,
                        borderColor: 'rgba(72, 158, 238, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true}}
                }
            });

            //Mostrar el contenedor del gráfico
            document.getElementById('contenedorGrafico').style.display = 'block';
        }
    </script>

{% endblock %}