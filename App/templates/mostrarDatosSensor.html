{% extends "layout.html" %} <!--Herencia de layout-->

{% block head %}

    <title>{% trans %} Datos sensor {% endtrans %}</title>

    <!--Biblioteca para los gráficos-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--Biblioteca para los calendarios-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{% endblock %}



{% block body %}
    
    <!--Paciente-->
    <h1> <img src="{{bbddpaciente.foto}}" alt="Imagen del paciente" class="logo">  Paciente: {{bbddpaciente.nombre}} {{bbddpaciente.apellido}} (id: {{bbddpaciente.id_paciente}})</h1>
    

    <!--Formulario para saber qué gráfica mostrar-->
    <form id="formulario" action="" method="post">
        <label for="seleccionGrafico">{% trans %} Selecciona la gráfica a mostrar: {% endtrans %}</label>
        <select id="seleccionGrafico" name="seleccionGrafico" required>
            <option value="">{% trans %} Seleccionar {% endtrans %}</option>
            <option value="1">{% trans %} Parámetros de Bradicinesia {% endtrans %}</option>
            <option value="2">{% trans %} Parámetros de FoG y Discinesia {% endtrans %}</option>
            <option value="3">{% trans %} Información de los pasos {% endtrans %}</option>
            <option value="4">{% trans %} Parámetros de Estado Motor, Discinesia y Bradicinesia a 10 min {% endtrans %}</option>
        </select>


        <label for="calendario">Selecciona el año y mes:</label>
        <input type="text" id="calendario" name="calendario" required>

        <div id="calendario-selector"></div>


        <button type="submit" class="btn btn-primary mt-2">{% trans %} Mostrar datos {% endtrans %}</button>
    </form>

    <!--Gráfica usando chart-->
    <div id="contenedorGrafico" style="width: 800px; height: 400px; margin: 0 auto;">
        <canvas id="gráfico"></canvas>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            flatpickr('#calendario', {
                dateFormat: 'Y-m-d', // Formato de fecha deseado
                mode: 'range', // Permite la selección de un rango de fechas
                onChange: function (selectedDates, dateStr) {
                if (selectedDates.length === 2) {
                    const fechaInicio = selectedDates[0];
                    const fechaFin = selectedDates[1];

                    const añoInicio = fechaInicio.getFullYear();
                    const mesInicio = fechaInicio.getMonth() + 1;
                    const añoFin = fechaFin.getFullYear();
                    const mesFin = fechaFin.getMonth() + 1;

                    // Realizar la solicitud de los días disponibles para el rango seleccionado
                    fetch(`/registros-disponibles?añoInicio=${añoInicio}&mesInicio=${mesInicio}&añoFin=${añoFin}&mesFin=${mesFin}`)
                        .then(response => response.json())
                        .then(data => {
                            mostrarCalendario(data);
                        })
                        .catch(error => {
                            console.error('Error al obtener los días disponibles:', error);
                        });
                }
            }
            });
    
            function mostrarCalendario(data) {
                const calendarioSelector = document.getElementById('calendario-selector');
                calendarioSelector.innerHTML = ''; // Limpiamos el calendario antes de agregar nuevos elementos
    
                const año = new Date().getFullYear();
                const mes = new Date().getMonth() + 1;
    
                // Crear elementos HTML para el calendario
                const calendarioDiv = document.createElement('div');
                calendarioDiv.classList.add('calendario');
    
                // Añadir título al calendario
                const titulo = document.createElement('h2');
                titulo.textContent = `${data.mesesDisponibles[mes - 1]} ${año}`;
                calendarioDiv.appendChild(titulo);
    
                // Crear tabla para los días del mes
                const tabla = document.createElement('table');
                const cabecera = document.createElement('tr');
    
                // Añadir cabeceras para los días de la semana
                for (let i = 0; i < 7; i++) {
                    const th = document.createElement('th');
                    th.textContent = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'][i];
                    cabecera.appendChild(th);
                }
                tabla.appendChild(cabecera);
    
                // Calcular el primer día del mes y el último día del mes
                const primerDiaMes = new Date(año, mes - 1, 1);
                const ultimoDiaMes = new Date(año, mes, 0);
    
                let contadorDias = 1;
                let fila = document.createElement('tr');
    
                // Rellenar los días del mes
                for (let i = 0; i < 7; i++) {
                    const dia = document.createElement('td');
                    if (i < primerDiaMes.getDay() || contadorDias > ultimoDiaMes.getDate()) {
                        dia.textContent = '';
                    } else {
                        dia.textContent = contadorDias;
                        contadorDias++;
                    }
                    fila.appendChild(dia);
                }
                tabla.appendChild(fila);
    
                // Agregar tabla al calendario
                calendarioDiv.appendChild(tabla);
    
                // Agregar calendario al contenedor
                calendarioSelector.appendChild(calendarioDiv);
            }
        });



        //Funcion que genera un gráfico
        function mostrarGrafico(fechaInicio, fechaFin) {

            //Matplotlib deberia hacerlo solo usando la funcion plot3Axis en app.py pero no funciona 
            //Esto por ahora es un gráfico de prueba con datos aleatorios
            var seleccion = document.getElementById('seleccionGrafico').value;
            var titulo = ''; //Título del gráfico dependiendo de la opcion seleccionada
            switch (seleccion) {//MAL
                case '1':
                    titulo = 'Número de pasos detectados'; break;
                case '2':
                    titulo = 'Longitud de pasos del paciente'; break;
                case '3':
                    titulo = 'Velocidad de zancada'; break;
                case '4':
                    titulo = 'Transiciones posturales'; break;
                case '5':
                    titulo = 'Episodios de bloqueos de la marcha'; break;
                default:
                    titulo = '';
            }
            var ctx = document.getElementById('gráfico').getContext('2d');


            var gráfico = new Chart(ctx, {
                type: 'line',
                
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'], //labels,
                    datasets: [{
                        label: titulo,
                        data: [65, 59, 80, 81, 56, 55, 40], //data,
                        borderColor: 'rgba(72, 158, 238, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true}}
                }
            });

            //Mostrar el contenedor del gráfico
            document.getElementById('contenedorGrafico').style.display = 'block';
        }
    </script>

{% endblock %}